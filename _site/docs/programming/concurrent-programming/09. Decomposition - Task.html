<h1 id="task-decomposition">Task Decomposition</h1>

<p>As in the metaphor (Designer, Manufacturer and Manager), we can describe the task decomposition is way to hire the workers into designing / manufacturing and managing and work concurrently as possible.</p>

<details open="">
  <summary class="text-delta">
    Table of contents
  </summary>
<ul id="markdown-toc">
  <li><a href="#task-decomposition" id="markdown-toc-task-decomposition">Task Decomposition</a>    <ul>
      <li><a href="#pipeline-pattern" id="markdown-toc-pipeline-pattern">Pipeline Pattern</a>        <ul>
          <li><a href="#dependency-graph-example" id="markdown-toc-dependency-graph-example">Dependency Graph Example</a></li>
          <li><a href="#python-example" id="markdown-toc-python-example">Python Example</a></li>
          <li><a href="#c-example" id="markdown-toc-c-example">C++ Example</a></li>
        </ul>
      </li>
      <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li>
    </ul>
  </li>
</ul>

</details>

<h2 id="pipeline-pattern">Pipeline Pattern</h2>

<p>Pipeline pattern is the most common in task decomposition.</p>

<p>We design the steps be in different resources (thread / processes ) and then control the internal outputs/artifacts between the steps by IPC or thread-safe queues, because the steps are usually not finished at the same time.</p>

<h3 id="dependency-graph-example">Dependency Graph Example</h3>

<p><img src="https://sangdo-han.github.io/docs/programming/concurrent-programming/images/09_task_pipeline.png" /></p>

<h3 id="python-example">Python Example</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Queue</span>
<span class="kn">import</span> <span class="nn">typing</span> <span class="k">as</span> <span class="n">T</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">Timer</span>

<span class="n">Workload</span> <span class="o">=</span> <span class="n">T</span><span class="p">.</span><span class="n">AnyStr</span>

<span class="k">class</span> <span class="nc">SharedCounter</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">:</span><span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">initial_value</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_mutex</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Lock</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">increment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="p">.</span><span class="n">_mutex</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_value</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">def</span> <span class="nf">decrement</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="p">.</span><span class="n">_mutex</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_value</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="p">.</span><span class="n">_mutex</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_value</span>

<span class="k">class</span> <span class="nc">Worker</span><span class="p">(</span><span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">in_queue</span><span class="p">:</span> <span class="n">Queue</span><span class="p">[</span><span class="n">Workload</span><span class="p">],</span>
        <span class="n">out_queue</span><span class="p">:</span> <span class="n">T</span><span class="p">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">Queue</span><span class="p">[</span><span class="n">Workload</span><span class="p">]],</span>
        <span class="n">job_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">turnaround_time</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">num_projects</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>  <span class="c1"># Ensure workers know the number of projects
</span>        <span class="n">process_counter</span><span class="p">:</span> <span class="n">T</span><span class="p">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">SharedCounter</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">in_queue</span> <span class="o">=</span> <span class="n">in_queue</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">out_queue</span> <span class="o">=</span> <span class="n">out_queue</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">job_type</span> <span class="o">=</span> <span class="n">job_type</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">turnaround_time</span> <span class="o">=</span> <span class="n">turnaround_time</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">num_projects</span> <span class="o">=</span> <span class="n">num_projects</span>
        <span class="k">if</span> <span class="n">process_counter</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">process_counter</span> <span class="o">=</span> <span class="n">process_counter</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">process_counter</span> <span class="o">=</span> <span class="n">SharedCounter</span><span class="p">(</span><span class="n">initial_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">self</span><span class="p">.</span><span class="n">process_counter</span><span class="p">.</span><span class="n">get</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">num_projects</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">workload</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">in_queue</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Avoid infinite blocking
</span>            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># Keep checking if no task available
</span>
            <span class="k">if</span> <span class="n">workload</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">in_queue</span><span class="p">.</span><span class="n">task_done</span><span class="p">()</span>
                <span class="k">break</span>  <span class="c1"># Stop if sentinel received
</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">job_type</span><span class="si">}</span><span class="s"> .... </span><span class="si">{</span><span class="n">workload</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">turnaround_time</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">process_counter</span><span class="p">.</span><span class="n">increment</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">out_queue</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">out_queue</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">workload</span><span class="p">)</span>

            <span class="bp">self</span><span class="p">.</span><span class="n">in_queue</span><span class="p">.</span><span class="n">task_done</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Pipeline</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_projects</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">num_projects</span> <span class="o">=</span> <span class="n">num_projects</span>

    <span class="k">def</span> <span class="nf">assemble_leathers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Queue</span><span class="p">[</span><span class="n">Workload</span><span class="p">]:</span>
        <span class="n">projects_in</span><span class="p">:</span> <span class="n">Queue</span><span class="p">[</span><span class="n">Workload</span><span class="p">]</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">num_projects</span><span class="p">):</span>
            <span class="n">projects_in</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="sa">f</span><span class="s">"Shoes #</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">projects_in</span>

    <span class="k">def</span> <span class="nf">run_concurrently</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">to_be_planned</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">assemble_leathers</span><span class="p">()</span>
        <span class="n">to_be_programmed</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="n">to_be_finalized</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>

        <span class="n">designer</span> <span class="o">=</span> <span class="n">Worker</span><span class="p">(</span><span class="n">to_be_planned</span><span class="p">,</span> <span class="n">to_be_programmed</span><span class="p">,</span> <span class="s">"Designer"</span><span class="p">,</span> <span class="n">turnaround_time</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">num_projects</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">num_projects</span><span class="p">)</span>

        <span class="c1"># Assume that data decomposition. we hired multiple manufacturers.
</span>        <span class="n">shared_counter</span> <span class="o">=</span> <span class="n">SharedCounter</span><span class="p">(</span><span class="n">initial_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># use as an atomic value in C++
</span>        <span class="c1"># suppose that manufacturer1 is more skillful than manufacturer2 
</span>        <span class="n">manufacturer1</span> <span class="o">=</span> <span class="n">Worker</span><span class="p">(</span><span class="n">to_be_programmed</span><span class="p">,</span> <span class="n">to_be_finalized</span><span class="p">,</span> <span class="s">"Manufacturer 1"</span><span class="p">,</span> <span class="n">turnaround_time</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">num_projects</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">num_projects</span><span class="p">,</span> <span class="n">process_counter</span><span class="o">=</span><span class="n">shared_counter</span><span class="p">)</span>
        <span class="n">manufacturer2</span> <span class="o">=</span> <span class="n">Worker</span><span class="p">(</span><span class="n">to_be_programmed</span><span class="p">,</span> <span class="n">to_be_finalized</span><span class="p">,</span> <span class="s">"Manufacturer 2"</span><span class="p">,</span> <span class="n">turnaround_time</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">num_projects</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">num_projects</span><span class="p">,</span> <span class="n">process_counter</span><span class="o">=</span><span class="n">shared_counter</span><span class="p">)</span>

        <span class="n">manager</span> <span class="o">=</span> <span class="n">Worker</span><span class="p">(</span><span class="n">to_be_finalized</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">"Manager"</span><span class="p">,</span> <span class="n">turnaround_time</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">num_projects</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">num_projects</span><span class="p">)</span>

        <span class="n">designer</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">manufacturer1</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">manufacturer2</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">manager</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>

        <span class="c1"># Wait for all tasks to be processed
</span>        <span class="n">designer</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">manufacturer1</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">manufacturer2</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">manager</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">timer</span><span class="p">:</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">num_projects</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">pipeline</span><span class="p">.</span><span class="n">run_concurrently</span><span class="p">()</span>

</code></pre></div></div>

<h3 id="c-example">C++ Example</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;queue&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;mutex&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;condition_variable&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;thread&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;memory&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;chrono&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">ThreadSafeQueue</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="kt">void</span> <span class="n">Push</span><span class="p">(</span><span class="n">T</span> <span class="n">item</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">m_Mutex</span><span class="p">);</span>
        <span class="n">m_Queue</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">item</span><span class="p">));</span>
        <span class="n">m_CV</span><span class="p">.</span><span class="n">notify_one</span><span class="p">();</span>
    <span class="p">}</span>
    
    <span class="kt">bool</span> <span class="n">Pop</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span> <span class="n">item</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span> <span class="n">timeout</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">m_Mutex</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">m_CV</span><span class="p">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="p">[</span><span class="k">this</span><span class="p">]</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!</span><span class="n">m_Queue</span><span class="p">.</span><span class="n">empty</span><span class="p">();</span> <span class="p">}))</span>
        <span class="p">{</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">m_Queue</span><span class="p">.</span><span class="n">front</span><span class="p">());</span>
            <span class="n">m_Queue</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

<span class="nl">private:</span>
    <span class="n">std</span><span class="o">::</span><span class="n">queue</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">m_Queue</span><span class="p">;</span>
    <span class="k">mutable</span> <span class="n">std</span><span class="o">::</span><span class="n">mutex</span> <span class="n">m_Mutex</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">condition_variable</span> <span class="n">m_CV</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">SharedCounter</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">SharedCounter</span><span class="p">(</span><span class="kt">int</span> <span class="n">initialValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">m_Value</span><span class="p">(</span><span class="n">initialValue</span><span class="p">)</span>
    <span class="p">{}</span>
    <span class="kt">void</span> <span class="n">Increment</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">m_Mutex</span><span class="p">);</span>
        <span class="o">++</span><span class="n">m_Value</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">void</span> <span class="n">Decrement</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">m_Mutex</span><span class="p">);</span>
        <span class="o">--</span><span class="n">m_Value</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">int</span> <span class="n">Get</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">m_Mutex</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">m_Value</span><span class="p">;</span>
    <span class="p">}</span>
<span class="nl">private:</span>
    <span class="kt">int</span> <span class="n">m_Value</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">mutex</span> <span class="n">m_Mutex</span><span class="p">;</span>

<span class="p">};</span>

<span class="k">class</span> <span class="nc">Worker</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">Worker</span><span class="p">(</span>
        <span class="n">ThreadSafeQueue</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">queueIn</span><span class="p">,</span>
        <span class="n">ThreadSafeQueue</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;*</span> <span class="n">queueOut</span><span class="p">,</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">jobType</span><span class="p">,</span>
        <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span> <span class="n">turnaroundTime</span><span class="p">,</span>
        <span class="kt">int</span> <span class="n">numProjects</span><span class="p">,</span>
        <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">SharedCounter</span><span class="o">&gt;</span> <span class="n">processCounter</span> <span class="o">=</span> <span class="nb">nullptr</span>
    <span class="p">)</span>
    <span class="o">:</span> <span class="n">m_QueueIn</span><span class="p">(</span><span class="n">queueIn</span><span class="p">)</span>
    <span class="p">,</span> <span class="n">m_QueueOut</span><span class="p">(</span><span class="n">queueOut</span><span class="p">)</span>
    <span class="p">,</span> <span class="n">m_JobType</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">jobType</span><span class="p">))</span>
    <span class="p">,</span> <span class="n">m_TurnaroundTime</span><span class="p">(</span><span class="n">turnaroundTime</span><span class="p">)</span>
    <span class="p">,</span> <span class="n">m_NumProjects</span><span class="p">(</span><span class="n">numProjects</span><span class="p">)</span>
    <span class="p">,</span> <span class="n">m_ProcessCounter</span><span class="p">(</span><span class="n">processCounter</span> <span class="o">?</span> <span class="n">processCounter</span> <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">SharedCounter</span><span class="o">&gt;</span><span class="p">())</span>
    <span class="p">{}</span>

    <span class="kt">void</span> <span class="n">Start</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">m_Thread</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Worker</span><span class="o">::</span><span class="n">run</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="n">Join</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">m_Thread</span><span class="p">.</span><span class="n">joinable</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="n">m_Thread</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="o">~</span><span class="n">Worker</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">Join</span><span class="p">();</span>
    <span class="p">}</span>

<span class="nl">private:</span>
    <span class="kt">void</span> <span class="n">run</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">m_ProcessCounter</span><span class="o">-&gt;</span><span class="n">Get</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">m_NumProjects</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">workload</span><span class="p">;</span>
            <span class="kt">bool</span> <span class="n">isPopped</span> <span class="o">=</span> <span class="n">m_QueueIn</span><span class="p">.</span><span class="n">Pop</span><span class="p">(</span><span class="n">workload</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">seconds</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">isPopped</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">m_JobType</span> <span class="o">&lt;&lt;</span> <span class="s">" .... "</span> <span class="o">&lt;&lt;</span> <span class="n">workload</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
                <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="n">m_TurnaroundTime</span><span class="p">);</span>
                <span class="n">m_ProcessCounter</span><span class="o">-&gt;</span><span class="n">Increment</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">m_QueueOut</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">m_QueueOut</span><span class="o">-&gt;</span><span class="n">Push</span><span class="p">(</span><span class="n">workload</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="nl">private:</span>
    <span class="n">ThreadSafeQueue</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">m_QueueIn</span><span class="p">;</span>
    <span class="n">ThreadSafeQueue</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;*</span> <span class="n">m_QueueOut</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">m_JobType</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span> <span class="n">m_TurnaroundTime</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">m_NumProjects</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">SharedCounter</span><span class="o">&gt;</span> <span class="n">m_ProcessCounter</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">m_Thread</span><span class="p">;</span>

<span class="p">};</span>

<span class="k">class</span> <span class="nc">Pipeline</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">Pipeline</span><span class="p">(</span><span class="kt">int</span> <span class="n">numProjects</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">m_NumProjects</span><span class="p">(</span><span class="n">numProjects</span><span class="p">)</span>
    <span class="p">{}</span>

    <span class="kt">void</span> <span class="n">RunConcurrently</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">ThreadSafeQueue</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">toBePlanned</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">m_NumProjects</span><span class="p">;</span> <span class="o">++</span><span class="n">idx</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">toBePlanned</span><span class="p">.</span><span class="n">Push</span><span class="p">(</span><span class="s">"Shoes #"</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">idx</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="n">ThreadSafeQueue</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">toBeProgrammed</span><span class="p">;</span>
        <span class="n">ThreadSafeQueue</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">toBeFinalized</span><span class="p">;</span>

        <span class="n">Worker</span> <span class="n">designer</span><span class="p">(</span><span class="n">toBePlanned</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">toBeProgrammed</span><span class="p">,</span> <span class="s">"Designer"</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span> <span class="n">m_NumProjects</span><span class="p">);</span>

        <span class="k">auto</span> <span class="n">sharedCounter</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">SharedCounter</span><span class="o">&gt;</span><span class="p">();</span>
        <span class="n">Worker</span> <span class="n">manufacturer1</span><span class="p">(</span><span class="n">toBeProgrammed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">toBeFinalized</span><span class="p">,</span> <span class="s">"Manufacturer 1"</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="p">(</span><span class="mi">400</span><span class="p">),</span> <span class="n">m_NumProjects</span><span class="p">,</span> <span class="n">sharedCounter</span><span class="p">);</span>
        <span class="n">Worker</span> <span class="n">manufacturer2</span><span class="p">(</span><span class="n">toBeProgrammed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">toBeFinalized</span><span class="p">,</span> <span class="s">"Manufacturer 2"</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span> <span class="n">m_NumProjects</span><span class="p">,</span> <span class="n">sharedCounter</span><span class="p">);</span>

        <span class="n">Worker</span> <span class="n">manager</span><span class="p">(</span><span class="n">toBeFinalized</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="s">"Manager"</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">m_NumProjects</span><span class="p">);</span>

        <span class="n">designer</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
        <span class="n">manufacturer1</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
        <span class="n">manufacturer2</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
        <span class="n">manager</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>

        <span class="n">designer</span><span class="p">.</span><span class="n">Join</span><span class="p">();</span>
        <span class="n">manufacturer1</span><span class="p">.</span><span class="n">Join</span><span class="p">();</span>
        <span class="n">manufacturer2</span><span class="p">.</span><span class="n">Join</span><span class="p">();</span>
        <span class="n">manager</span><span class="p">.</span><span class="n">Join</span><span class="p">();</span>
    <span class="p">}</span>
<span class="nl">private:</span>
    <span class="kt">int</span> <span class="n">m_NumProjects</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">Timer</span>
<span class="p">{</span>    
<span class="nl">public:</span>
    <span class="n">Timer</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="o">~</span><span class="n">Timer</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">auto</span> <span class="n">end</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
        <span class="k">auto</span> <span class="n">duration</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">);</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Time taken: "</span> <span class="o">&lt;&lt;</span> <span class="n">duration</span><span class="p">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">" milliseconds"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
<span class="nl">private:</span>
    <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">time_point</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">&gt;</span> <span class="n">start</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="p">{</span>
        <span class="n">Timer</span> <span class="n">timer</span><span class="p">;</span>
        <span class="n">Pipeline</span> <span class="n">pipeline</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
        <span class="n">pipeline</span><span class="p">.</span><span class="n">RunConcurrently</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>

<p>Pipeline pattern is often used in the big data ETL (Extract, Transform, Load) process. As you can have noticed, the pipeline allows us to limit the number of threads, such as in the thread pool. This is why it is most useful when the number of shared resources is limited.</p>

